import{r as n,u as Se,l as Ee,b as f,j as s}from"./index-BJZa08pc.js";import{F as ke}from"./ArrowLeftIcon-CTtRk3Gn.js";import{F as Ae}from"./TrashIcon-B1UT3Xy1.js";function Me({title:l,titleId:d,...r},u){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:u,"aria-labelledby":d},r),l?n.createElement("title",{id:d},l):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"}))}const Le=n.forwardRef(Me);function Re({title:l,titleId:d,...r},u){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:u,"aria-labelledby":d},r),l?n.createElement("title",{id:d},l):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"}))}const $e=n.forwardRef(Re);function De({title:l,titleId:d,...r},u){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:u,"aria-labelledby":d},r),l?n.createElement("title",{id:d},l):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"}))}const Ie=n.forwardRef(De),Pe=()=>{const[l,d]=n.useState([]),[r,u]=n.useState(null),[$,g]=n.useState([]),[E,W]=n.useState(""),[H,K]=n.useState(!1),[k,ie]=n.useState(null),q=n.useRef(null),_=Se(),[z]=Ee(),[b,D]=n.useState(!1),[I,G]=n.useState([]),[y,N]=n.useState(""),[Q,X]=n.useState(!1),[x,A]=n.useState(""),[F,T]=n.useState(!1),[M,p]=n.useState([]),[j,v]=n.useState(-1),O=n.useRef(null),[Y,ee]=n.useState(null),[L,U]=n.useState(""),[P,B]=n.useState(!1),[ce,se]=n.useState(null),[oe,w]=n.useState(!1),[le,V]=n.useState([]),C=(k?.role||"").toUpperCase()==="TRAINER",te=r?le.includes(r):!1;n.useEffect(()=>{S(),de()},[]),n.useEffect(()=>{r&&J(r)},[r]),n.useEffect(()=>{ve()},[$]),n.useEffect(()=>{try{const e=localStorage.getItem("mutedConversations"),t=e?JSON.parse(e):[];V(Array.isArray(t)?t:[])}catch{V([])}},[r]);const de=()=>{const e=localStorage.getItem("user");e&&ie(JSON.parse(e))},R=e=>e?Array.isArray(e)?e:Array.isArray(e?.data)?e.data:Array.isArray(e?.data?.data)?e.data.data:[]:[],S=async()=>{try{const e=await f.get("/messages/conversations");if(e.status>=200&&e.status<300){const t=e?.data??null,c=R(t).map(i=>{const o=i.user||{},m=o?.trainerProfile?.name||o?.clientProfile?.name||o?.name||o?.email||"Usuario";return{id:i.userId||o?.id,name:m,email:o?.email||"",lastMessage:i?.lastMessage?.content||"",lastMessageTime:i?.lastMessage?.createdAt||"",unreadCount:i?.unreadCount??0}});d(c)}else d(t=>Array.isArray(t)?t:[])}catch(e){console.error("Error al obtener conversaciones:",e),d([])}},J=async e=>{try{const t=await f.get(`/messages/conversation/${e}`);if(t.status>=200&&t.status<300){const a=t?.data??null,c=R(a);g(c)}else g(a=>Array.isArray(a)?a:[])}catch(t){console.error("Error al obtener mensajes:",t),g([])}};n.useEffect(()=>{const e=z.get("to");e&&(u(e),J(e))},[z]);const me=async e=>{try{await f.patch(`/messages/mark-read/${e}`)}catch(t){console.error("Error al marcar mensajes como leídos:",t)}},ue=async()=>{if(r)try{await me(r),g(e=>e.map(t=>({...t,isRead:!0}))),await S()}catch(e){console.error("Error al marcar como leídos:",e)}finally{w(!1)}},he=()=>{r&&(V(e=>{const t=e.includes(r)?e.filter(a=>a!==r):[...e,r];try{localStorage.setItem("mutedConversations",JSON.stringify(t))}catch(a){console.error("No se pudo guardar silencio en localStorage:",a)}return t}),w(!1))},fe=()=>{C&&h?.id&&_(`/trainer/clients/${h.id}`),w(!1)},ge=()=>{const e={conversationWith:{id:h?.id,name:h?.name,email:h?.email},messages:$};try{const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(t),c=document.createElement("a"),i=(h?.name||"conversation").replace(/\s+/g,"_").toLowerCase();c.href=a,c.download=`chat_${i}.json`,c.click(),URL.revokeObjectURL(a)}catch(t){console.error("No se pudo exportar el chat:",t)}w(!1)},ae=async()=>{if(!(!E.trim()||!r)){K(!0);try{const e=await f.post("/messages/send",{content:E,receiverId:r});if(e.status>=200&&e.status<300){const t=e?.data?.data??e?.data??null;t&&g(a=>[...a,t]),W(""),S()}}catch(e){console.error("Error al enviar mensaje:",e)}finally{K(!1)}}},xe=e=>{ee(e.id),U(e.content)},ne=()=>{ee(null),U(""),B(!1)},pe=async e=>{if(L.trim())try{B(!0);const t=await f.patch(`/messages/${e}`,{content:L.trim()});if(t.status>=200&&t.status<300){const a=t?.data??{};g(c=>c.map(i=>i.id===e?{...i,content:a.content,updatedAt:a.updatedAt}:i)),ne(),S()}}catch(t){console.error("Error al editar mensaje:",t)}finally{B(!1)}},je=async e=>{if(window.confirm("¿Eliminar este mensaje?"))try{se(e);const a=await f.delete(`/messages/${e}`);a.status>=200&&a.status<300&&(g(c=>c.filter(i=>i.id!==e)),S())}catch(a){console.error("Error al borrar mensaje:",a)}finally{se(null)}},ve=()=>{q.current?.scrollIntoView({behavior:"smooth"})},Ne=e=>new Date(e).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}),be=e=>{const t=new Date(e),a=new Date,c=new Date(a);return c.setDate(c.getDate()-1),t.toDateString()===a.toDateString()?"Hoy":t.toDateString()===c.toDateString()?"Ayer":t.toLocaleDateString("es-ES",{day:"numeric",month:"short"})},h=(l||[]).find(e=>e.id===r),ye=async()=>{try{X(!0);const t=(await f.get("/trainer/clients"))?.data??null;let a=R(t);if(!a.length){const c=t?.data?.clients||t?.clients||t?.data?.data?.clients;a=Array.isArray(c)?c:[]}G(a),p(a)}catch(e){console.error("Error al obtener clientes:",e),G([]),p([])}finally{X(!1)}};n.useEffect(()=>{if(!b)return;const e=x.trim();if(v(-1),!e){p([]),T(!1);return}T(!0);const t=new AbortController,a=setTimeout(async()=>{try{const i=(await f.get("/trainer/clients",{params:{search:e,limit:10,page:1},signal:t.signal}))?.data??null;let o=R(i);if(!o.length){const m=i?.data?.clients||i?.clients||i?.data?.data?.clients;o=Array.isArray(m)?m:[]}if(e&&o.length&&!Array.isArray(i?.data?.clients)&&o.length===I.length){const m=o.filter(Z=>`${Z.name||Z.fullName||""} ${Z.email||""}`.toLowerCase().includes(e.toLowerCase()));p(m)}else p(o)}catch{const i=I.filter(o=>`${o.name||o.fullName||""} ${o.email||""}`.toLowerCase().includes(e.toLowerCase()));p(i)}finally{T(!1)}},300);return()=>{clearTimeout(a),t.abort()}},[x,b,I]),n.useEffect(()=>{if(!O.current||j<0)return;const e=O.current.querySelector(`[data-index="${j}"]`);e&&"scrollIntoView"in e&&e.scrollIntoView({block:"nearest"})},[j]);const we=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),re=(e,t)=>{if(!t)return e;const a=we(t),c=new RegExp(`(${a})`,"ig"),i=e.split(c);return s.jsx(s.Fragment,{children:i.map((o,m)=>new RegExp(a,"i").test(o)?s.jsx("span",{className:"highlight",children:o},m):s.jsx("span",{children:o},m))})},Ce=e=>{if(!b)return;const t=M.length;if(e.key==="ArrowDown")e.preventDefault(),v(a=>Math.min(t-1,a+1));else if(e.key==="ArrowUp")e.preventDefault(),v(a=>Math.max(0,a-1));else if(e.key==="Enter"){if(j>=0&&j<t){const a=M[j];a?.id&&N(a.id)}}else e.key==="Escape"&&(D(!1),N(""),v(-1))};return s.jsxs("div",{className:"messaging-system",children:[s.jsxs("div",{className:"conversations-sidebar",children:[s.jsxs("div",{className:"conversations-header",children:[s.jsxs("div",{className:"header-actions",children:[s.jsxs("button",{onClick:()=>_(C?"/trainer-dashboard":`/client-dashboard/${k?.id||""}`),className:"back-btn",children:[s.jsx(ke,{className:"back-icon"}),"Volver al Dashboard"]}),C&&s.jsx("button",{onClick:()=>{const e=!b;D(e),e?(A(""),N(""),ye()):(N(""),A(""),v(-1))},className:"new-conversation-btn",children:"Nueva conversación"})]}),s.jsx("h2",{className:"page-title",children:"Mensajes"})]}),b&&C&&s.jsxs("div",{className:"new-conversation-panel",children:[s.jsx("label",{className:"new-conversation-label",children:"Busca y selecciona un cliente:"}),s.jsxs("div",{className:"client-search-control",children:[s.jsx("input",{className:"client-search-input",type:"text",placeholder:"Escribe nombre o email...",value:x,onChange:e=>A(e.target.value),onKeyDown:Ce,disabled:Q}),x&&s.jsx("button",{className:"clear-search-btn",type:"button",onClick:()=>{A(""),p([]),v(-1),N("")},children:"×"})]}),x.trim()!==""&&s.jsxs("div",{className:"client-search-results",ref:O,children:[Q&&s.jsx("div",{className:"search-status",children:"Cargando clientes..."}),F&&s.jsx("div",{className:"search-status",children:"Buscando..."}),!F&&M.length===0&&s.jsx("div",{className:"empty-search",children:"Sin resultados"}),!F&&M.map((e,t)=>s.jsxs("div",{"data-index":t,className:`client-result-item ${y===e.id?"selected":""} ${j===t?"active":""}`,onClick:()=>N(e.id),onMouseEnter:()=>v(t),children:[s.jsx("div",{className:"client-result-name",children:re(e.name||e.fullName||e.email||"",x)}),e.email&&s.jsx("div",{className:"client-result-email",children:re(e.email,x)})]},e.id))]}),s.jsx("div",{className:"new-conversation-actions",children:s.jsx("button",{className:"start-chat-btn",onClick:()=>{y&&(u(y),J(y),D(!1))},disabled:!y,children:"Abrir chat"})})]}),s.jsx("div",{className:"conversations-list",children:(l||[]).length===0?s.jsx("div",{style:{color:"rgba(255,255,255,0.7)"},children:"No hay conversaciones disponibles"}):(l||[]).map(e=>s.jsx("div",{onClick:()=>u(e.id),className:`conversation-item ${r===e.id?"active":""}`,children:s.jsxs("div",{className:"conversation-content",children:[s.jsxs("div",{className:"conversation-info",children:[s.jsx("h3",{className:"conversation-name",children:e.name}),s.jsx("p",{className:"last-message",children:e.lastMessage||"Sin mensajes"})]}),s.jsxs("div",{className:"conversation-meta",children:[e.lastMessageTime&&s.jsx("p",{className:"message-time",children:be(e.lastMessageTime)}),e.unreadCount>0&&s.jsx("span",{className:"unread-badge",children:e.unreadCount})]})]})},e.id))})]}),s.jsx("div",{className:"chat-area",children:r?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"chat-header",children:s.jsxs("div",{className:"chat-user-info",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"chat-user-name",children:h?.name||"Usuario"}),s.jsx("p",{className:"chat-user-email",children:h?.email||""}),te&&s.jsx("span",{className:"chat-muted-badge",children:"Silenciada"})]}),s.jsx("button",{className:"chat-options-btn",onClick:()=>w(e=>!e),children:s.jsx(Le,{className:"options-icon"})}),oe&&s.jsxs("div",{className:"chat-options-menu",children:[s.jsx("button",{className:"chat-options-item",onClick:ue,children:"Marcar todos como leídos"}),C&&s.jsx("button",{className:"chat-options-item",onClick:fe,children:"Ir al perfil del cliente"}),s.jsx("button",{className:"chat-options-item",onClick:he,children:te?"Desactivar silencio":"Silenciar conversación"}),s.jsx("button",{className:"chat-options-item",onClick:ge,children:"Exportar chat (.json)"})]})]})}),s.jsxs("div",{className:"messages-container",children:[($||[]).map(e=>s.jsxs("div",{className:`message ${e.senderId===k?.id?"sent":"received"}`,children:[s.jsx("div",{className:"message-bubble",children:Y===e.id?s.jsxs("div",{children:[s.jsx("input",{className:"message-edit-input",type:"text",value:L,onChange:t=>U(t.target.value),disabled:P}),s.jsxs("div",{className:"message-edit-actions",children:[s.jsx("button",{className:"message-edit-save",onClick:()=>pe(e.id),disabled:P||!L.trim(),children:"Guardar"}),s.jsx("button",{className:"message-edit-cancel",onClick:ne,disabled:P,children:"Cancelar"})]})]}):s.jsxs(s.Fragment,{children:[s.jsx("p",{className:"message-content",children:e.content}),s.jsx("p",{className:"message-time",children:Ne(e.createdAt)})]})}),e.senderId===k?.id&&Y!==e.id&&s.jsxs("div",{className:"message-actions",children:[s.jsx("button",{className:"message-action-btn",title:"Editar",onClick:()=>xe(e),children:s.jsx(Ie,{className:"message-action-icon"})}),s.jsx("button",{className:"message-action-btn",title:"Borrar",onClick:()=>je(e.id),disabled:ce===e.id,children:s.jsx(Ae,{className:"message-action-icon"})})]})]},e.id)),s.jsx("div",{ref:q})]}),s.jsx("div",{className:"message-input-container",children:s.jsxs("div",{className:"message-input-wrapper",children:[s.jsx("input",{type:"text",value:E,onChange:e=>W(e.target.value),onKeyPress:e=>e.key==="Enter"&&ae(),placeholder:"Escribe un mensaje...",className:"message-input",disabled:H}),s.jsx("button",{onClick:ae,disabled:H||!E.trim(),className:"send-btn",children:s.jsx($e,{className:"send-icon"})})]})})]}):s.jsx("div",{className:"empty-chat",children:s.jsxs("div",{className:"empty-chat-content",children:[s.jsx("h3",{className:"empty-title",children:"Selecciona una conversación"}),s.jsx("p",{className:"empty-description",children:"Elige un cliente para comenzar a chatear"})]})})})]})};export{Pe as default};
